import{_ as U,c as d,o as i,a as e,F as b,g as h,t as c,s as E,h as _,i as A,l as T,j as B,n as z,k as f,v as y,q as R,A as j,d as q,p as v,x as F,r as M,b as L,m as V,B as I}from"./index-DwHvbeIw.js";const Q={props:{users:Array}},W={class:"card"},P={class:"card-body"},$={class:"table table-striped"},J={class:"badge bg-info"},G=["onClick"],H=["onClick"];function K(o,s,l,a,p,u){return i(),d("div",W,[e("div",P,[e("table",$,[s[0]||(s[0]=e("thead",{class:"table-dark"},[e("tr",null,[e("th",null,"First Name"),e("th",null,"WhatsApp"),e("th",null,"Role"),e("th",null,"Organizations"),e("th",null,"Registered By"),e("th",null,"Status"),e("th",null,"Actions")])],-1)),e("tbody",null,[(i(!0),d(b,null,h(l.users,t=>(i(),d("tr",{key:t.id},[e("td",null,c(t.first_name),1),e("td",null,c(t.whatsapp_number),1),e("td",null,c(t.role),1),e("td",null,[(i(!0),d(b,null,h(t.organizations,m=>(i(),d("span",{key:m.id,class:"badge bg-primary me-1"},c(m.name),1))),128))]),e("td",null,[e("span",J,c(t.created_by_admin?"Admin":"Self"),1)]),e("td",null,[e("span",{class:E(t.is_active?"badge bg-success":"badge bg-danger")},c(t.is_active?"Active":"Inactive"),3)]),e("td",null,[e("button",{onClick:m=>o.$emit("edit",t),class:"btn btn-warning btn-sm"},"Edit",8,G),e("button",{onClick:m=>o.$emit("toggle-status",t),class:"btn btn-danger btn-sm"},c(t.is_active?"Deactivate":"Activate"),9,H)])]))),128))])])])])}const X=U(Q,[["render",K]]),w=F(),Y={props:{user:Object},setup(o,{emit:s}){const l=_({whatsapp_number:"",first_name:"",password:"",role:"tester",organizations:[],is_active:!0,created_by_admin:!0}),a=_([]),p=_([]),u=_(""),t=_([]),m=async()=>{try{const r=await v.get("/organizations/");a.value=r.data,t.value=[...r.data]}catch(r){console.error("Failed to fetch organizations:",r)}},k=async()=>{try{const r=await v.get("/roles/");p.value=r.data}catch(r){console.error("Failed to fetch roles:",r)}},S=()=>{if(!u.value){t.value=[...a.value];return}const r=u.value.toLowerCase();t.value=a.value.filter(n=>n.name.toLowerCase().includes(r))},C=r=>{const n=a.value.find(g=>g.id===r);return n?n.name:"Unknown Organization"},O=r=>{l.value.organizations=l.value.organizations.filter(n=>n!==r)};A(()=>o.user,r=>{if(r){const n=r.user_organizations?r.user_organizations.map(g=>g.organization.id):[];l.value={whatsapp_number:r.whatsapp_number,first_name:r.first_name,password:"",role:r.role,organizations:n,is_active:r.is_active,created_by_admin:r.created_by_admin}}else l.value={whatsapp_number:"",first_name:"",password:"",role:"tester",organizations:[],is_active:!0,created_by_admin:!0}},{immediate:!0});const x=async()=>{var r;try{const n={whatsapp_number:l.value.whatsapp_number,first_name:l.value.first_name,role:l.value.role,is_active:l.value.is_active,created_by_admin:l.value.created_by_admin,organizations:l.value.organizations.map(N=>Number(N))};if(l.value.password&&(n.password=l.value.password),n.organizations.length===0){w.warning("Please select at least one organization");return}console.log("Sending payload:",n);const g=o.user?`/users/${o.user.id}/`:"/users/",D=o.user?"put":"post",Me=await v({method:D,url:g,data:n,headers:{"Content-Type":"application/json"}});w.success(`User ${o.user?"updated":"registered"} successfully!`),s("close"),s("refresh")}catch(n){console.error("Error saving user:",n);let g="Operation failed";(r=n.response)!=null&&r.data?n.response.data.organizations?g=`Organization error: ${n.response.data.organizations.join(", ")}`:n.response.data.detail?g=n.response.data.detail:g=JSON.stringify(n.response.data):n.message&&(g=n.message),w.error(g)}};return T(()=>{m(),k()}),{formData:l,saveUser:x,organizations:a,roles:p,orgSearchQuery:u,filteredOrganizations:t,filterOrganizations:S,getOrgName:C,removeOrganization:O}}},Z={class:"modal-overlay"},ee={class:"modal-content"},se={class:"modal-title"},te={class:"form-group"},ae={class:"form-group"},oe={class:"form-group"},re={key:0},ne={class:"form-group"},le=["value"],ie={class:"form-group"},de={class:"search-container"},ce={class:"organization-checkboxes"},ue={key:0,class:"no-results"},me=["id","value"],ge=["for"],pe={key:0,class:"selected-organizations"},ve={class:"selected-tags"},fe=["onClick"],_e={class:"modal-actions"},be={type:"submit",class:"btn btn-success"};function he(o,s,l,a,p,u){return i(),d("div",Z,[e("div",ee,[e("h4",se,c(l.user?"Edit User":"Register New User"),1),e("form",{onSubmit:s[8]||(s[8]=B((...t)=>a.saveUser&&a.saveUser(...t),["prevent"]))},[e("div",te,[s[9]||(s[9]=e("label",null,"WhatsApp Number",-1)),f(e("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=t=>a.formData.whatsapp_number=t),class:"form-control",placeholder:"Enter WhatsApp number",required:""},null,512),[[y,a.formData.whatsapp_number]])]),e("div",ae,[s[10]||(s[10]=e("label",null,"Name",-1)),f(e("input",{type:"text","onUpdate:modelValue":s[1]||(s[1]=t=>a.formData.first_name=t),class:"form-control",placeholder:"Enter name",required:""},null,512),[[y,a.formData.first_name]])]),e("div",oe,[s[11]||(s[11]=e("label",null,"Password",-1)),f(e("input",{type:"password","onUpdate:modelValue":s[2]||(s[2]=t=>a.formData.password=t),class:"form-control",placeholder:"Enter a strong password"},null,512),[[y,a.formData.password]]),l.user?(i(),d("p",re,"Leave blank to keep current password.")):z("",!0)]),e("div",ne,[s[12]||(s[12]=e("label",null,"Role",-1)),f(e("select",{"onUpdate:modelValue":s[3]||(s[3]=t=>a.formData.role=t),class:"form-control",required:""},[(i(!0),d(b,null,h(a.roles,t=>(i(),d("option",{key:t.value,value:t.value},c(t.label),9,le))),128))],512),[[R,a.formData.role]])]),e("div",ie,[s[14]||(s[14]=e("label",null,"Organizations",-1)),e("div",de,[f(e("input",{type:"text","onUpdate:modelValue":s[4]||(s[4]=t=>a.orgSearchQuery=t),class:"search-input",placeholder:"Search organizations...",onInput:s[5]||(s[5]=(...t)=>a.filterOrganizations&&a.filterOrganizations(...t))},null,544),[[y,a.orgSearchQuery]]),s[13]||(s[13]=e("span",{class:"search-icon"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[e("path",{d:"M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"})])],-1))]),e("div",ce,[a.filteredOrganizations.length===0?(i(),d("div",ue," No organizations found ")):z("",!0),(i(!0),d(b,null,h(a.filteredOrganizations,t=>(i(),d("div",{key:t.id,class:"form-check"},[f(e("input",{type:"checkbox",id:"org-"+t.id,class:"form-check-input",value:t.id,"onUpdate:modelValue":s[6]||(s[6]=m=>a.formData.organizations=m)},null,8,me),[[j,a.formData.organizations]]),e("label",{for:"org-"+t.id,class:"form-check-label"},c(t.name),9,ge)]))),128))]),s[15]||(s[15]=e("small",{class:"text-muted"},"Select one or more organizations",-1))]),a.formData.organizations.length>0?(i(),d("div",pe,[s[16]||(s[16]=e("label",null,"Selected Organizations:",-1)),e("div",ve,[(i(!0),d(b,null,h(a.formData.organizations,t=>(i(),d("span",{key:t,class:"tag"},[q(c(a.getOrgName(t))+" ",1),e("button",{type:"button",onClick:m=>a.removeOrganization(t),class:"tag-remove"}," Ã— ",8,fe)]))),128))])])):z("",!0),e("div",_e,[e("button",be,c(l.user?"Save Changes":"Register"),1),e("button",{type:"button",onClick:s[7]||(s[7]=t=>o.$emit("close")),class:"btn btn-secondary"},"Cancel")])],32)])])}const ye=U(Y,[["render",he],["__scopeId","data-v-f8a7c004"]]),ze={components:{UserTable:X,UserModal:ye},data(){return{users:[],selectedUser:null,showUserModal:!1}},setup(){return{router:I()}},methods:{async fetchUsers(){try{const o=await v.get("/users/");this.users=o.data}catch(o){console.error("Error fetching users:",o)}},openUserModal(o){this.selectedUser=o?{...o}:null,this.showUserModal=!0},closeUserModal(){this.showUserModal=!1,this.fetchUsers()},async saveUser(o){try{o.id?await v.put(`/users/${o.id}/`,o):await v.post("/users/",{...o,created_by_admin:!0}),this.closeUserModal()}catch(s){console.error("Error saving user:",s)}},async toggleStatus(o){try{await v.put(`/users/${o.id}/`,{...o,is_active:!o.is_active}),this.fetchUsers()}catch(s){console.error("Error updating status:",s)}}},mounted(){this.fetchUsers()}},we={class:"container mt-4"},Ue={class:"d-flex justify-content-between align-items-center mb-3"};function ke(o,s,l,a,p,u){const t=M("UserTable"),m=M("UserModal");return i(),d("div",we,[e("div",Ue,[s[1]||(s[1]=e("h3",{class:"text-primary"},"System Management",-1)),e("button",{onClick:s[0]||(s[0]=k=>u.openUserModal(null)),class:"btn btn-primary"},"+ Add User")]),L(t,{users:p.users,onEdit:u.openUserModal,onToggleStatus:u.toggleStatus},null,8,["users","onEdit","onToggleStatus"]),p.showUserModal?(i(),V(m,{key:0,user:p.selectedUser,onClose:u.closeUserModal,onSave:u.saveUser},null,8,["user","onClose","onSave"])):z("",!0)])}const Ce=U(ze,[["render",ke]]);export{Ce as default};
